class Coupon < ActiveRecord::Base
  # extends ...................................................................
  encrypted_id key: 'pVXy9ChXEe2Fmmfa'
  # includes ..................................................................
  # security (i.e. attr_accessible) ...........................................
  # relationships .............................................................
  has_and_belongs_to_many :orders
  # validations ...............................................................
  # callbacks .................................................................
  # scopes ....................................................................
  scope :by_device, ->(device_id) { where(:to => [device_id, 'ALL']) }
  scope :today, -> {
    today = Date.today.beginning_of_day
    where("start_time <= ? AND end_time >= ?", today, today)
  }
  scope :enabled, -> { where(enabled: true) }
  scope :separate, -> { where(separate: true) }
  scope :validity, -> { today.enabled }


  # additional config .........................................................
  # class methods .............................................................
  # public instance methods ...................................................
  def used!(device_id, order)
    number = self.number - 1
    number = number < 0 ? 0 : number
    update_attribute(:number, number)
    update_attribute(:enabled, false) if number == 0
    order.coupons << self
  end
  # protected instance methods ................................................
  # private instance methods ..................................................
end
